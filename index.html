<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyverse Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .status-indicator.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-indicator.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .connect-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .connect-button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .connect-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .takings-display {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .takings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .takings-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .takings-item .label {
            font-weight: 500;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }
        
        .takings-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }
        
        .instructions {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #2196f3;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            color: #424242;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        .error-message {
            background: #ffebee;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: none;
        }
        
        .success-message {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Loyverse Dashboard</h1>
            <p>Simple & Working - Connect once, see your totals</p>
        </div>
        
        <div class="status-card">
            <div id="status-indicator" class="status-indicator disconnected">
                ðŸ”´ Not Connected
            </div>
            <h2>Connect to Loyverse</h2>
            <p>Click the button below to securely connect your Loyverse account</p>
            <button id="connect-btn" class="connect-button" onclick="connectToLoyverse()">
                ðŸ”— Connect with OAuth
            </button>
            <button id="refresh-btn" class="connect-button" onclick="refreshData()" disabled>
                ðŸ”„ Refresh Data
            </button>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            <h3>Or enter your Access Token manually:</h3>
            <input type="text" id="manual-token" placeholder="Paste your Loyverse Access Token here" 
                   style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <button class="connect-button" onclick="useManualToken()" style="background: #28a745;">
                âœ… Use This Token
            </button>
        </div>
        
        <div id="error-msg" class="error-message"></div>
        <div id="success-msg" class="success-message"></div>
        
        <div class="takings-display">
            <h2>Your Takings</h2>
            <div class="takings-grid">
                <div class="takings-item">
                    <span class="label">Today</span>
                    <div class="value" id="today-takings">Â£0.00</div>
                </div>
                <div class="takings-item">
                    <span class="label">This Week</span>
                    <div class="value" id="week-takings">Â£0.00</div>
                </div>
                <div class="takings-item">
                    <span class="label">This Month</span>
                    <div class="value" id="month-takings">Â£0.00</div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ðŸš€ How to Deploy (2 minutes)</h3>
            <ol>
                <li><strong>Push to GitHub:</strong> Your files are already in the main branch</li>
                <li><strong>Enable GitHub Pages:</strong> Go to Settings â†’ Pages â†’ Source: Deploy from branch</li>
                <li><strong>Set branch:</strong> main, folder: / (root)</li>
                <li><strong>Add redirect URL:</strong> In your Loyverse app, add: <code>https://kirky29.github.io/Loyverse/</code></li>
                <li><strong>Test:</strong> Click "Connect to Loyverse" on your live app</li>
            </ol>
        </div>
    </div>

    <script>
        let isConnected = false;
        let accessToken = null;
        
        // Check if we're on localhost or production
        function isLocalhost() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        }
        
        // Get the base URL for API calls
        function getApiBase() {
            if (isLocalhost()) {
                return 'http://localhost:3001';
            }
            return ''; // Same origin in production
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-msg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-msg');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Update connection status
        function updateStatus(connected) {
            isConnected = connected;
            const statusIndicator = document.getElementById('status-indicator');
            const connectBtn = document.getElementById('connect-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            
            if (connected) {
                statusIndicator.textContent = 'ðŸŸ¢ Connected to Loyverse';
                statusIndicator.className = 'status-indicator connected';
                connectBtn.disabled = true;
                refreshBtn.disabled = false;
            } else {
                statusIndicator.textContent = 'ðŸ”´ Not Connected';
                statusIndicator.className = 'status-indicator disconnected';
                connectBtn.disabled = false;
                refreshBtn.disabled = true;
            }
        }
        
        // Connect to Loyverse via OAuth
        function connectToLoyverse() {
            const clientId = 'eQ7QAMonUnzNORRE8xuG';
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'receipts.read stores.read';
            
            // Generate a random state parameter for security
            const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('oauthState', state);
            
            // Build the Loyverse OAuth URL
            const oauthUrl = new URL('https://developer.loyverse.com/oauth/authorize');
            oauthUrl.searchParams.set('response_type', 'code');
            oauthUrl.searchParams.set('client_id', clientId);
            oauthUrl.searchParams.set('redirect_uri', redirectUri);
            oauthUrl.searchParams.set('scope', scope);
            oauthUrl.searchParams.set('state', state);
            
            // Redirect directly instead of popup (works better with GitHub Pages)
            window.location.href = oauthUrl.toString();
        }
        
        // Check for OAuth result in URL params
        function checkOAuthResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const returnedState = urlParams.get('state');
            
            if (error) {
                showError(`OAuth error: ${error}`);
                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code && returnedState) {
                // Validate state parameter for security
                const expectedState = localStorage.getItem('oauthState');
                if (returnedState === expectedState) {
                    // State is valid, proceed with token exchange
                    localStorage.removeItem('oauthState'); // Clean up
                    exchangeCodeForToken(code);
                } else {
                    showError('OAuth state validation failed. Please try again.');
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
        
        // Exchange authorization code for access token
        async function exchangeCodeForToken(code) {
            try {
                showSuccess('Exchanging code for access token...');
                
                // Use a CORS proxy to call Loyverse token endpoint
                const corsProxy = 'https://cors-anywhere.herokuapp.com/';
                const tokenUrl = 'https://developer.loyverse.com/oauth/token';
                
                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: 'eQ7QAMonUnzNORRE8xuG',
                    client_secret: '_b7646LxCSky-I5U6h3IfBvJ17VoKmKN0FTaz07xzwceAJmfj-giEg==',
                    redirect_uri: window.location.origin + window.location.pathname,
                    code: code
                });

                const response = await fetch(corsProxy + tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body.toString()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Token exchange failed: ${response.status} - ${errorText}`);
                }

                const tokenData = await response.json();
                
                if (tokenData.access_token) {
                    accessToken = tokenData.access_token;
                    localStorage.setItem('loyverseAccessToken', tokenData.access_token);
                    
                    showSuccess('Successfully connected to Loyverse!');
                    updateStatus(true);
                    
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Auto-refresh data
                    setTimeout(() => {
                        refreshData();
                    }, 1000);
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (err) {
                console.error('Token exchange error:', err);
                showError(`Failed to get access token: ${err.message}`);
            }
        }
        
        // Refresh data from Loyverse
        async function refreshData() {
            if (!accessToken) {
                showError('Not connected to Loyverse. Please connect first.');
                return;
            }
            
            try {
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const nowISO = today.toISOString();
                const startOfDayISO = startOfDay.toISOString();
                const startOfWeekISO = startOfWeek.toISOString();
                const startOfMonthISO = startOfMonth.toISOString();
                
                // Try multiple CORS proxies in case one fails
                const corsProxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors.bridged.cc/'
                ];
                
                const loyverseBase = 'https://api.loyverse.com/v0.7/receipts';
                
                // Function to try a specific CORS proxy
                async function tryProxy(proxyUrl) {
                    try {
                        const response = await fetch(proxyUrl + loyverseBase + `?created_at_min=${startOfDayISO}&created_at_max=${nowISO}&limit=1000`, {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const text = await response.text();
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                throw new Error(`Invalid JSON response: ${text.substring(0, 100)}`);
                            }
                        } else {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (err) {
                        throw new Error(`Proxy ${proxyUrl} failed: ${err.message}`);
                    }
                }
                
                // Try each proxy until one works
                let todayData, weekData, monthData;
                let lastError;
                
                for (const proxy of corsProxies) {
                    try {
                        [todayData, weekData, monthData] = await Promise.all([
                            tryProxy(proxy),
                            tryProxy(proxy),
                            tryProxy(proxy)
                        ]);
                        break; // Success, exit loop
                    } catch (err) {
                        lastError = err;
                        continue; // Try next proxy
                    }
                }
                
                if (!todayData || !weekData || !monthData) {
                    throw new Error(`All CORS proxies failed. Last error: ${lastError.message}`);
                }
                
                // Calculate totals from receipts
                const todayTotal = calculateTotal(todayData.receipts || []);
                const weekTotal = calculateTotal(weekData.receipts || []);
                const monthTotal = calculateTotal(monthData.receipts || []);
                
                document.getElementById('today-takings').textContent = formatCurrency(todayTotal);
                document.getElementById('week-takings').textContent = formatCurrency(weekTotal);
                document.getElementById('month-takings').textContent = formatCurrency(monthTotal);
                showSuccess('Data refreshed successfully!');
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError(`Failed to refresh data: ${error.message}`);
                
                // Show helpful error message
                if (error.message.includes('CORS')) {
                    showError('CORS proxy issue. Try refreshing the page or wait a few minutes.');
                }
            }
        }
        
        // Calculate total from receipts array
        function calculateTotal(receipts) {
            let total = 0;
            for (const receipt of receipts) {
                if (typeof receipt.total_money_amount === 'number') {
                    total += receipt.total_money_amount / 100;
                } else if (receipt.total_money && typeof receipt.total_money.amount === 'number') {
                    total += receipt.total_money.amount / 100;
                }
            }
            return total;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP'
            }).format(amount);
        }
        
        // Load saved token on startup
        function loadSavedToken() {
            const savedToken = localStorage.getItem('loyverseAccessToken');
            if (savedToken) {
                accessToken = savedToken;
                updateStatus(true);
            }
        }

        // Use manual token
        function useManualToken() {
            const manualTokenInput = document.getElementById('manual-token').value;
            if (manualTokenInput) {
                accessToken = manualTokenInput;
                localStorage.setItem('loyverseAccessToken', accessToken);
                updateStatus(true);
                showSuccess('Successfully connected with manual token!');
                refreshData(); // Refresh data with the new token
            } else {
                showError('Please enter a valid Loyverse Access Token.');
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedToken();
            checkOAuthResult(); // Check if we're returning from OAuth
            updateStatus(accessToken !== null);
        });
    </script>
</body>
</html>
